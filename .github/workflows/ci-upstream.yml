name: CI (with upstream verification)

on:
  push:
  pull_request:

jobs:
  upstream-build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout upstream repo
        uses: actions/checkout@v4
        with:
          repository: streetsidesoftware/vscode-spell-checker
          path: upstream

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node modules for upstream
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-upstream-npm-${{ hashFiles('upstream/**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-upstream-npm-

      - name: Install upstream dependencies
        working-directory: upstream
        run: npm ci

      - name: Build upstream
        working-directory: upstream
        run: npm run build --if-present

      - name: Test upstream
        working-directory: upstream
        run: npm test --if-present

      - name: Upload upstream test artifacts (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upstream-artifacts
          path: upstream/packages/**/test-results || upstream/test-results || upstream/**/*.log || upstream/**/*.json

      - name: Run our repository checks (if package.json exists)
        run: |
          if [ -f package.json ]; then
            echo "Found package.json in repo, running npm ci && tests";
            npm ci;
            npm run build --if-present;
            npm test --if-present;
          else
            echo "No package.json in repo - skipping npm steps";
          fi

      - name: Run our term-extraction script (if present)
        if: always()
        run: |
          if [ -f scripts/extract_terms.js ]; then
            echo "Running extract_terms.js ...";
            node scripts/extract_terms.js streetsidesoftware/vscode-spell-checker || true;
          else
            echo "No extract script found - skipping";
          fi

      - name: Upload generated terms.json (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-terms
          path: generated/terms.json

      - name: Run classification script (if present)
        if: always()
        run: |
          if [ -f scripts/classify_terms.js ]; then
            echo "Running classify_terms.js ...";
            node scripts/classify_terms.js || true;
          else
            echo "No classify script found - skipping";
          fi

      - name: Upload classified terms
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: classified-terms
          path: generated/*.json

      - name: Lint / quick smoke
        run: |
          echo "CI verification complete"
